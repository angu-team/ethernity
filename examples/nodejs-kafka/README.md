# Ethernity Kafka Examples - Node.js

Este diret√≥rio cont√©m exemplos completos de como usar Node.js para se inscrever em filas Kafka e processar eventos do Ethernity Workspace em tempo real.

## üìã Pr√©-requisitos

- Node.js 16+ 
- Kafka rodando (local ou remoto)
- NPM ou Yarn

## üöÄ Instala√ß√£o

1. Instale as depend√™ncias:
```bash
npm install
```

2. Configure as vari√°veis de ambiente:
```bash
cp .env.example .env
# Edite o arquivo .env com suas configura√ß√µes
```

3. Teste a conectividade:
```bash
npm test
```

## üìÅ Estrutura dos Arquivos

### `consumer.js` - Consumidor B√°sico de Eventos
Consumidor simples que se inscreve em eventos Kafka e processa diferentes tipos de eventos blockchain.

**Caracter√≠sticas:**
- Processamento de eventos em tempo real
- Handlers espec√≠ficos para cada tipo de evento
- Sistema de logging estruturado
- Estat√≠sticas de processamento
- Parada graciosa

**Uso:**
```bash
npm run consumer
```

### `subscription-manager.js` - Gerenciador de Inscri√ß√µes
Sistema avan√ßado para gerenciar inscri√ß√µes de eventos dinamicamente atrav√©s de comandos Kafka.

**Caracter√≠sticas:**
- Cria√ß√£o, atualiza√ß√£o e remo√ß√£o de inscri√ß√µes
- Valida√ß√£o de dados com Joi
- Filtros personaliz√°veis
- M√∫ltiplos m√©todos de notifica√ß√£o
- Rate limiting

**Uso:**
```bash
npm run subscription-manager
```

### `event-processor.js` - Processador Avan√ßado
Processador sofisticado que analisa padr√µes, detecta anomalias e processa eventos em lotes.

**Caracter√≠sticas:**
- Processamento em lotes para alta performance
- Detec√ß√£o de padr√µes suspeitos
- An√°lise de correla√ß√µes entre eventos
- Sistema de alertas
- Detec√ß√£o de MEV e ataques

**Uso:**
```bash
npm run event-processor
```

### `test-consumer.js` - Testes e Valida√ß√£o
Suite de testes para validar conectividade e funcionalidade dos exemplos.

**Uso:**
```bash
npm test
```

## üîß Configura√ß√£o

### Vari√°veis de Ambiente (.env)

```env
# Configura√ß√µes do Kafka
KAFKA_BROKERS=localhost:9092
KAFKA_CLIENT_ID=ethernity-nodejs-consumer
KAFKA_GROUP_ID=ethernity-events-group

# T√≥picos Kafka
TOPIC_EVENTS=ethernity-events
TOPIC_SUBSCRIPTIONS=ethernity-subscriptions
TOPIC_NOTIFICATIONS=ethernity-notifications

# Configura√ß√µes de logging
LOG_LEVEL=info

# Configura√ß√µes de retry
MAX_RETRIES=3
RETRY_DELAY_MS=1000

# Configura√ß√µes de processamento
BATCH_SIZE=100
PROCESSING_TIMEOUT_MS=30000
```

## üìä Tipos de Eventos Suportados

### 1. `erc20_created` - Cria√ß√£o de Token ERC20
```json
{
  "event_type": "erc20_created",
  "timestamp": "2024-01-01T12:00:00Z",
  "data": {
    "contract_address": "0x...",
    "creator": "0x...",
    "name": "Token Name",
    "symbol": "TKN",
    "total_supply": "1000000000000000000000000"
  }
}
```

### 2. `token_swap` - Swap de Tokens
```json
{
  "event_type": "token_swap",
  "timestamp": "2024-01-01T12:00:00Z",
  "data": {
    "user": "0x...",
    "token_in": {
      "address": "0x...",
      "symbol": "ETH",
      "decimals": 18
    },
    "token_out": {
      "address": "0x...",
      "symbol": "USDC",
      "decimals": 6
    },
    "amount_in": "1000000000000000000",
    "amount_out": "2500000000",
    "dex_protocol": "UniswapV3"
  }
}
```

### 3. `large_transfer` - Transfer√™ncia Grande
```json
{
  "event_type": "large_transfer",
  "timestamp": "2024-01-01T12:00:00Z",
  "data": {
    "from": "0x...",
    "to": "0x...",
    "amount": "50000000000000000000000",
    "usd_value": 50000,
    "token": {
      "address": "0x...",
      "symbol": "USDT",
      "decimals": 6
    }
  }
}
```

### 4. `liquidation` - Liquida√ß√£o
```json
{
  "event_type": "liquidation",
  "timestamp": "2024-01-01T12:00:00Z",
  "data": {
    "liquidated_user": "0x...",
    "liquidator": "0x...",
    "collateral_token": {
      "address": "0x...",
      "symbol": "ETH"
    },
    "debt_token": {
      "address": "0x...",
      "symbol": "USDC"
    },
    "liquidated_amount": "1000000000000000000"
  }
}
```

### 5. `rug_pull_warning` - Alerta de Rug Pull
```json
{
  "event_type": "rug_pull_warning",
  "timestamp": "2024-01-01T12:00:00Z",
  "data": {
    "token": {
      "address": "0x...",
      "symbol": "SCAM"
    },
    "deployer": "0x...",
    "risk_score": 0.95,
    "risk_indicators": [
      "honeypot_detected",
      "liquidity_removed",
      "ownership_not_renounced"
    ]
  }
}
```

### 6. `mev_activity` - Atividade MEV
```json
{
  "event_type": "mev_activity",
  "timestamp": "2024-01-01T12:00:00Z",
  "data": {
    "mev_type": "sandwich_attack",
    "bot_address": "0x...",
    "profit_usd": 1500,
    "gas_used": 250000,
    "victim_tx": "0x..."
  }
}
```

### 7. `flash_loan` - Flash Loan
```json
{
  "event_type": "flash_loan",
  "timestamp": "2024-01-01T12:00:00Z",
  "data": {
    "user": "0x...",
    "token": {
      "address": "0x...",
      "symbol": "DAI"
    },
    "amount": "1000000000000000000000000",
    "fee": "900000000000000000000",
    "protocol": "Aave"
  }
}
```

### 8. `governance_event` - Evento de Governan√ßa
```json
{
  "event_type": "governance_event",
  "timestamp": "2024-01-01T12:00:00Z",
  "data": {
    "governance_type": "proposal_created",
    "proposal_id": "123",
    "proposer": "0x...",
    "description": "Increase protocol fee to 0.3%",
    "voting_power": "1000000000000000000000"
  }
}
```

## üéØ Exemplos de Uso

### Consumidor B√°sico com Handler Personalizado

```javascript
const { EthernityEventConsumer } = require('./consumer');

const consumer = new EthernityEventConsumer();

// Registra handler personalizado para swaps grandes
consumer.registerEventHandler('token_swap', async (event, topic) => {
  const { amount_in, token_in, usd_value } = event.data;
  
  if (usd_value > 100000) { // Swaps > $100k
    console.log('üö® Swap grande detectado:', {
      valor: usd_value,
      token: token_in.symbol,
      usuario: event.data.user
    });
    
    // Enviar notifica√ß√£o, salvar no banco, etc.
    await sendAlert('large_swap', event.data);
  }
});

await consumer.start();
```

### Criando Inscri√ß√µes Dinamicamente

```javascript
const { createSubscriptionCommand } = require('./subscription-manager');

// Cria inscri√ß√£o para transfer√™ncias grandes
const subscription = createSubscriptionCommand('create', {
  data: {
    user_id: 'whale-tracker-001',
    event_type: 'large_transfer',
    filters: {
      general: {
        min_value_usd: 1000000, // Apenas transfer√™ncias > $1M
        include_mempool: true,
        address_whitelist: [
          '0x...' // Endere√ßos espec√≠ficos para monitorar
        ]
      }
    },
    notification_config: {
      method: 'webhook',
      webhook_url: 'https://api.myapp.com/webhooks/whale-alert',
      retry_policy: {
        max_retries: 5,
        initial_delay: 1000
      }
    },
    rate_limit: {
      events_per_minute: 10,
      events_per_hour: 100
    }
  }
});

// Envia comando via Kafka
await producer.send({
  topic: 'ethernity-subscriptions',
  messages: [{
    key: 'create',
    value: JSON.stringify(subscription)
  }]
});
```

### Processamento Avan√ßado com Detec√ß√£o de Padr√µes

```javascript
const { AdvancedEventProcessor } = require('./event-processor');

const processor = new AdvancedEventProcessor();

// O processador automaticamente detecta:
// - Sandwich attacks
// - Atividade MEV suspeita
// - Padr√µes de rug pull
// - Volumes an√¥malos
// - Correla√ß√µes entre eventos

await processor.start();

// Obt√©m estat√≠sticas em tempo real
setInterval(() => {
  const stats = processor.getDetailedStats();
  console.log('üìä Estat√≠sticas:', stats);
}, 60000);
```

## üîç Monitoramento e Logs

Todos os exemplos incluem logging estruturado com Winston:

- **Console**: Logs coloridos para desenvolvimento
- **Arquivo**: Logs persistentes em arquivos
- **N√≠veis**: debug, info, warn, error
- **Formato**: JSON estruturado com timestamps

### Configura√ß√£o de Log Level

```bash
# .env
LOG_LEVEL=debug  # Para desenvolvimento
LOG_LEVEL=info   # Para produ√ß√£o
LOG_LEVEL=warn   # Apenas avisos e erros
```

## üìà Performance e Escalabilidade

### Configura√ß√µes Recomendadas

**Para Alto Volume (>1000 eventos/segundo):**
```env
BATCH_SIZE=500
PROCESSING_TIMEOUT_MS=60000
KAFKA_GROUP_ID=ethernity-high-volume-group
```

**Para Baixa Lat√™ncia:**
```env
BATCH_SIZE=10
PROCESSING_TIMEOUT_MS=5000
```

### M√∫ltiplas Inst√¢ncias

Para escalar horizontalmente, execute m√∫ltiplas inst√¢ncias com o mesmo `KAFKA_GROUP_ID`. O Kafka distribuir√° automaticamente as parti√ß√µes entre as inst√¢ncias.

## üö® Tratamento de Erros

Todos os exemplos incluem:

- **Retry autom√°tico** com backoff exponencial
- **Dead letter queues** para mensagens problem√°ticas
- **Circuit breakers** para servi√ßos externos
- **Graceful shutdown** em sinais do sistema
- **Health checks** para monitoramento

## üîí Seguran√ßa

### Configura√ß√£o SASL/SSL (Produ√ß√£o)

```javascript
const kafka = new Kafka({
  clientId: 'ethernity-secure-client',
  brokers: ['kafka1:9093', 'kafka2:9093'],
  ssl: true,
  sasl: {
    mechanism: 'SCRAM-SHA-256',
    username: process.env.KAFKA_USERNAME,
    password: process.env.KAFKA_PASSWORD
  }
});
```

### Valida√ß√£o de Dados

Todos os dados s√£o validados com Joi antes do processamento:

```javascript
const eventSchema = Joi.object({
  event_type: Joi.string().required(),
  timestamp: Joi.date().iso().required(),
  data: Joi.object().required()
});
```

## üêõ Troubleshooting

### Problemas Comuns

1. **Kafka n√£o conecta:**
   - Verifique se o Kafka est√° rodando
   - Confirme o endere√ßo dos brokers
   - Teste conectividade de rede

2. **Mensagens n√£o s√£o consumidas:**
   - Verifique se os t√≥picos existem
   - Confirme o group ID
   - Verifique offsets

3. **Performance baixa:**
   - Aumente o batch size
   - Use m√∫ltiplas parti√ß√µes
   - Otimize processamento

### Comandos √öteis

```bash
# Testa conectividade
npm test

# Executa com logs debug
LOG_LEVEL=debug npm run consumer

# Monitora estat√≠sticas
npm run consumer 2>&1 | grep "Estat√≠sticas"

# Verifica t√≥picos Kafka
kafka-topics.sh --list --bootstrap-server localhost:9092
```

## üìö Recursos Adicionais

- [Documenta√ß√£o KafkaJS](https://kafka.js.org/)
- [Kafka Documentation](https://kafka.apache.org/documentation/)
- [Winston Logging](https://github.com/winstonjs/winston)
- [Joi Validation](https://joi.dev/)

## ü§ù Contribuindo

1. Fork o projeto
2. Crie uma branch para sua feature
3. Commit suas mudan√ßas
4. Push para a branch
5. Abra um Pull Request

## üìÑ Licen√ßa

MIT License - veja o arquivo LICENSE para detalhes.

